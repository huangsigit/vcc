<!DOCTYPE html>
<html xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
    <:include file="../common/css.html" title="用户管理"/>
    <script src="https://cdn.staticfile.org/vue/2.2.2/vue.min.js"></script>
</head>
<body>
<style>
    .layui-form-label{
        width: 100px;
    }
    .layui-input-block {
        margin-left: 130px;
        min-height: 36px
    }

    .layui-form.layui-form-info .layui-form-item {
        margin-bottom: 0 !important;
    }

    .layui-input-block.layui-word-aux {
        word-break: break-all;
        padding: 11px 0 !important;
        box-sizing: border-box !important;
    }

</style>

<!-- 正文开始 -->
<div class="layui-fluid" lay-filter="searchForm">
    <div class="layui-card">
        <div class="layui-card-body">
            <!-- 表格工具栏 -->

            <form class="layui-form toolbar" lay-filter="userTbSearchForm">

                <div class="layui-form-item">


                    <div class="layui-inline">
                        <label class="layui-form-label w-auto">请求ID:</label>
                        <div class="layui-input-inline">
                            <input name="purchase_request_id" id="purchase_request_id" class="layui-input" placeholder="输入请求ID"/>
                        </div>
                    </div>

                    <div class="layui-inline">
                        <label class="layui-form-label w-auto">卡号:</label>
                        <div class="layui-input-inline">
                            <input name="card_number" id="card_number" class="layui-input" placeholder="输入卡号"/>
                        </div>
                    </div>

                    <div class="layui-inline">
                        <label class="layui-form-label w-auto">卡片状态:</label>
                        <div class="layui-input-inline">
                            <select name="cardStatus" id="cardStatus" lay-search="">
                                <option value="">请选择</option>
                                <:for items="${cardStatusList}" var="item">
                                    <option value="${item.statusId}">${item.statusName}</option>
                                </:for>
                            </select>
                        </div>
                    </div>

                    <:if test="${type==0}">
                    <div class="layui-inline">
                        <label class="layui-form-label w-auto">分配用户:</label>
                        <div class="layui-input-inline">
                            <select name="userId" id="user_id" lay-search="">
                                <option value="">请选择</option>
                                <:for items="${userList}" var="item">
                                    <option value="${item.userId}">${item.customerName}</option>
                                </:for>
                            </select>
                        </div>
                    </div>
                    </:if>



                    <div class="layui-inline">
                        <button class="layui-btn icon-btn" lay-filter="userTbSearch" lay-submit>
                            <i class="layui-icon">&#xe615;</i>搜索
                        </button>
                    </div>

                </div>
            </form>


            <!-- 数据表格 -->
            <table id="cardDataTable" lay-filter="cardDataTable"></table>
        </div>
    </div>
</div>

<!-- 表格操作列 -->
<script type="text/html" id="userTbBar">

    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit" >修改</a>

    <a class="layui-btn layui-btn-danger layui-btn-xs"
       data-dropdown="#userTbDelDrop{{d.LAY_INDEX}}" no-shade="true">删除</a>
    <!--<a class="layui-btn layui-btn-xs" lay-event="reset">重置密码</a>-->
    <div class="dropdown-menu-nav dropdown-popconfirm dropdown-top-right layui-hide"
         id="userTbDelDrop{{d.LAY_INDEX}}"
         style="max-width: 200px;white-space: normal;min-width: auto;margin-left: -5px;">
        <div class="dropdown-anchor"></div>
        <div class="dropdown-popconfirm-title">
            <i class="layui-icon layui-icon-help"></i>
            <!--确定要删除{{d.nickName}}吗？-->
            确定要删除吗？
        </div>
        <div class="dropdown-popconfirm-btn">
            <a class="layui-btn" btn-cancel>取消</a>
            <a class="layui-btn layui-btn-normal" lay-event="del">确定</a>
        </div>
    </div>

</script>

<!-- 卡片操作 -->
<script type="text/html" id="userTbBarCard">


    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="info" >详情</a>

    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="recharge" >充值</a>

    <!--<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="allot" >分配</a>-->

    <a class="layui-btn layui-btn-danger layui-btn-xs"
       data-dropdown="#cardTbDrop{{d.LAY_INDEX}}" no-shade="true">注销</a>
    <!--<a class="layui-btn layui-btn-xs" lay-event="reset">重置密码</a>-->
    <div class="dropdown-menu-nav dropdown-popconfirm dropdown-top-right layui-hide"
         id="cardTbDrop{{d.LAY_INDEX}}"
         style="max-width: 200px;white-space: normal;min-width: auto;margin-left: 10px;">
        <div class="dropdown-anchor"></div>
        <div class="dropdown-popconfirm-title">
            <i class="layui-icon layui-icon-help"></i>
            <!--确定要删除{{d.nickName}}吗？-->
            确定要注销卡片吗？
        </div>
        <div class="dropdown-popconfirm-btn">
            <a class="layui-btn" btn-cancel>取消</a>
            <a class="layui-btn layui-btn-normal" lay-event="logout">确定</a>
        </div>
    </div>



</script>



<!-- 表格状态列 -->
<script type="text/html" id="userTbState">
    <input type="checkbox" lay-filter="userTbStateCk" value="{{d.userId}}" lay-skin="switch"
           lay-text="正常|锁定" {{d.state==0?'checked':''}}/>
</script>

<!-- 表单弹窗 -->
<script type="text/html" id="editFormDialog">
    <form id="editForm" lay-filter="editForm" class="layui-form model-form">

        <input name="id" type="hidden"/>

        <div class="layui-row">
        <div class="layui-col-md6">

        <div class="layui-form-item">
            <label class="layui-form-label layui-form-required">请求ID</label>
            <div class="layui-input-block">
                <input name="purchase_request_id" placeholder="请输入请求ID" type="number" class="layui-input"
                       lay-verify="required"/>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label layui-form-required">卡号</label>
            <div class="layui-input-block">
                <input name="card_number" placeholder="请输入卡号" type="number" class="layui-input"
                       lay-verify="required"/>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">编号</label>
            <div class="layui-input-block">
                <input name="number" placeholder="请输入编号" class="layui-input"/>
            </div>
        </div>


        <div class="layui-form-item">
            <label class="layui-form-label layui-form-required">卡片状态</label>
            <div class="layui-input-block">
                <select name="status" lay-verify="required" lay-search="">
                    <option value="1">已激活</option>
                    <option value="2">已注销</option>
                    <option value="3">注销中</option>
                </select>
            </div>

        </div>

            <div class="layui-form-item">
                <label class="layui-form-label layui-form-required">卡初始额度</label>
                <div class="layui-input-block">
                    <input name="init_amount" placeholder="请输入卡初始额度" type="number" class="layui-input"
                           lay-verify="required"/>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label layui-form-required"><:if test="${type==0}">对外</:if>卡额度</label>
                <div class="layui-input-block">
                    <input name="external_amount" placeholder="请输入卡额度" type="number" class="layui-input"
                           lay-verify="required"/>
                </div>
            </div>

        <:if test="${type==0}">
        <div class="layui-form-item">
            <label class="layui-form-label layui-form-required">实际卡额度</label>
            <div class="layui-input-block">
                <input name="actual_amount" placeholder="请输入实际卡额度" type="number" class="layui-input"
                       lay-verify="required"/>
            </div>
        </div>

            <div class="layui-form-item" style="display:none" id="logoutTimeDiv">
                <label class="layui-form-label">销卡日期</label>
                <div class="layui-input-block">
                    <input name="logout_time" type="text" class="layui-input" id="logoutTime" placeholder="yyyy-MM-dd">
                </div>
            </div>

        </:if>

        </div>

            <div class="layui-col-md6">

        <div class="layui-form-item">
            <label class="layui-form-label">预警金额</label>
            <div class="layui-input-block">
                <input name="warning_amount" placeholder="请输入预警金额" type="number" class="layui-input"
                       />
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">自动充值金额</label>
            <div class="layui-input-block">
                <input name="auto_recharge_amount" placeholder="请输入自动充值金额" type="number" class="layui-input"
                       />
            </div>
        </div>



        <div class="layui-form-item">
            <label class="layui-form-label layui-form-required">PIN码</label>
            <div class="layui-input-block">
                <input name="pin" placeholder="请输入PIN码" type="number" class="layui-input"
                       lay-verify="required"/>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label layui-form-required">开卡日</label>
            <div class="layui-input-block">
                <input name="create_time" type="text" class="layui-input" id="createTime" placeholder="yyyy-MM-dd" lay-verify="required">
            </div>
        </div>

        <:if test="${type==0}">

        <div class="layui-form-item" style="display:none" id="externalCreateTimeDiv">
            <label class="layui-form-label">外部开卡日</label>
            <div class="layui-input-block">
                <input name="external_create_time" type="text" class="layui-input" id="externalCreateTime" placeholder="yyyy-MM-dd">
            </div>
        </div>



        </:if>

        <div class="layui-form-item">
            <label class="layui-form-label layui-form-required">到期日</label>
            <div class="layui-input-block">
                <input name="end_time" type="text" class="layui-input" id="endTime" placeholder="yyyy-MM" lay-verify="required">
            </div>
        </div>


        <div class="layui-form-item" id="customerApp">
            <label class="layui-form-label">分配用户</label>
            <div class="layui-input-block" >
                <select @change='getValue' v-model="customer" name="user_id" lay-filter="user_id" lay-search="">
                    <option value="">请选择</option>
                    <option v-for="customer in customerList" :value="customer.value" >{{customer.name}}</option>
                </select>
            </div>
        </div>


        <div class="layui-form-item">
            <label class="layui-form-label">备注</label>
            <div class="layui-input-block">
                <input name="remark" placeholder="请输入备注" type="text" class="layui-input"
                       />
            </div>
        </div>

            </div>

        </div>



        <div class="layui-form-item text-right">
            <button class="layui-btn layui-btn-primary" type="button" ew-event="closeDialog">取消</button>
            <button class="layui-btn" lay-filter="editSubmit" lay-submit>保存</button>
        </div>

    </form>
</script>


<!-- 分配卡号表单弹窗 -->
<script type="text/html" id="editFormDialogAllot">
    <form id="editFormAllot" lay-filter="editFormAllot" class="layui-form model-form">

        <input id="allotId" name="id" type="hidden"/>

        <div class="layui-form-item" id="customerApp2">
            <label class="layui-form-label layui-form-required">分配用户</label>
            <div class="layui-input-block" >
                <select @change='getValue' v-model="customer" id="userId" name="userId" lay-filter="userId"
                        lay-verify="required" lay-search="">
                    <!--<option value="">请选择</option>-->
                    <option v-for="customer in customerList" :value="customer.value" >{{customer.name}}</option>
                </select>
            </div>
        </div>

        <div class="layui-form-item text-right">
            <button class="layui-btn layui-btn-primary" type="button" ew-event="closeDialog">取消</button>
            <button class="layui-btn" lay-filter="editSubmitAllot" lay-submit>保存</button>
        </div>

    </form>
</script>

<!-- 充值表单弹窗 -->

<script type="text/html" id="editFormDialogRecharge">
    <form id="editFormRecharge" lay-filter="editFormRecharge" class="layui-form model-form">

        <input name="id" type="hidden"/>

<!--
        <div class="layui-form-item" id="customerApp">
            <label class="layui-form-label layui-form-required">分配用户</label>
            <div class="layui-input-block" >
                <select @change='getValue' v-model="customer" id="customerId" name="customerId" lay-filter="customerId"
                        lay-verify="required">
                    &lt;!&ndash;<option value="">请选择</option>&ndash;&gt;
                    <option v-for="customer in customerList" :value="customer.value" >{{customer.name}}</option>
                </select>
            </div>
        </div>
-->





        <div class="layui-form-item">
            <label class="layui-form-label layui-form-required">充值金额</label>
            <div class="layui-input-block">
                <input name="recharge_amount" placeholder="金额不能大于可充值金额" type="number" class="layui-input" min="10"
                       lay-verType="tips" lay-verify="required|number|h5"
                       lay-verify="required"/>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label"><a style='color: red'>可充值金额</a>:</label>
            <div id="allot_recharge_amount" name="allot_recharge_amount" class="layui-input-block layui-word-aux"></div>
        </div>

        <:if test="${type==0}">
            <div class="layui-form-item">
                <label class="layui-form-label">实际卡额度:</label>
                <div id="actual_amount" name="actual_amount" class="layui-input-block layui-word-aux"></div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">实际剩于额度:</label>
                <div id="actual_remaining_amount" name="actual_remaining_amount" class="layui-input-block layui-word-aux"></div>
            </div>
        </:if>

        <div class="layui-form-item">
            <label class="layui-form-label">
                <:if test="${type==0}">对外</:if>卡额度:</label>
            <div id="external_amount" name="external_amount" class="layui-input-block layui-word-aux"></div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label"><:if test="${type==0}">对外</:if>剩于额度:</label>
            <div id="external_remaining_amount" name="external_remaining_amount" class="layui-input-block layui-word-aux"></div>
        </div>


        <div class="layui-form-item text-right">
            <button class="layui-btn layui-btn-primary" type="button" ew-event="closeDialog">取消</button>
            <button class="layui-btn" lay-filter="editSubmitRecharge" lay-submit>保存</button>
        </div>

    </form>
</script>


<!-- 详情表单弹窗 -->
<script type="text/html" id="operRecordInfoDialog">
    <div class="layui-form model-form layui-form-info">

        <input id="operId" name="id" type="hidden" value="{{d.id}}"/>
        <div class="layui-row">
            <div class="layui-col-md6">
                <div class="layui-form-item">
                    <label class="layui-form-label">请求ID:</label>
                    <div id="requestId" class="layui-input-block layui-word-aux">{{d.purchase_request_id}}</div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">卡号:</label>
                    <div class="layui-input-block layui-word-aux">{{d.card_number}}</div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">编号:</label>
                    <!--<div class="layui-input-block layui-word-aux">{{layui.util.toDateString(d.createTime)}}</div>-->
                    <div class="layui-input-block layui-word-aux">{{d.number}}</div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">使用状态:</label>
                    <div class="layui-input-block layui-word-aux">{{d.statusStr}}</div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">销卡日期:</label>
                    <div class="layui-input-block layui-word-aux">{{d.logout_time}}</div>
                </div>

                {{# if(d.type==0){ }}
                <div class="layui-form-item">
                    <label class="layui-form-label">归属客户:</label>
                    <div class="layui-input-block layui-word-aux">{{d.customer_name}}</div>
                </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">内部开卡日期:</label>
                        <div class="layui-input-block layui-word-aux">{{d.create_time}}</div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">外部开卡日期:</label>
                        <div class="layui-input-block layui-word-aux">{{d.external_create_time}}</div>
                    </div>
                {{# }else{ }}
                    <div class="layui-form-item">
                        <label class="layui-form-label">开卡日期:</label>
                        <div class="layui-input-block layui-word-aux">{{d.external_create_time}}</div>
                    </div>

                {{# } }}


                <div class="layui-form-item">
                    <label class="layui-form-label">有效期:</label>
                    <div class="layui-input-block layui-word-aux">{{d.end_time}}</div>
                </div>

            </div>



            <div class="layui-col-md6">


                <div class="layui-form-item">
                    <label class="layui-form-label">PIN:</label>
                    <div class="layui-input-block layui-word-aux">{{d.pin}}</div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">已用额度:</label>
                    <div class="layui-input-block layui-word-aux">{{d.use_amount}}</div>
                </div>



            {{# if(d.type==0){ }}
                <div class="layui-form-item">
                    <label class="layui-form-label">实际卡额度:</label>
                    <div class="layui-input-block layui-word-aux">{{d.actual_amount}}</div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">实际剩于额度:</label>
                    <div class="layui-input-block layui-word-aux">{{d.actual_remaining_amount}}</div>
                </div>


                <div class="layui-form-item">
                    <label class="layui-form-label">对外卡额度:</label>
                    <div class="layui-input-block layui-word-aux">{{d.external_amount}}</div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">对外剩于额度:</label>
                    <div class="layui-input-block layui-word-aux">{{d.external_remaining_amount}}</div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">预警金额:</label>
                    <div class="layui-input-block layui-word-aux">{{d.warning_amount}}</div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">自动充值金额:</label>
                    <div class="layui-input-block layui-word-aux">{{d.auto_recharge_amount}}</div>
                </div>

            {{# }else{ }}



                <div class="layui-form-item">
                    <label class="layui-form-label">卡额度:</label>
                    <div class="layui-input-block layui-word-aux">{{d.external_amount}}</div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">剩于额度:</label>
                    <div class="layui-input-block layui-word-aux">{{d.external_remaining_amount}}</div>
                </div>
            {{# } }}

            </div>




        </div>

        <div class="layui-form-item text-center">
            <!--<button id="recharge" class="layui-btn icon-btn" lay-filter="recharge" lay-submit><i class="layui-icon"></i>充值</button>-->

            {{# if(d.type==0){ }}
            <!--<a class="layui-btn layui-btn-primary" lay-event="allot" >分配</a>-->
            <button id="allot" class="layui-btn icon-btn" lay-filter="allot" lay-submit><i class="layui-icon"></i>分配卡片</button>
            {{# }else{ }}
            <!--<a class="layui-btn layui-btn-primary" lay-event="info" >详情</a>-->
            {{# } }}
            <!--<button id="logout" class="layui-btn icon-btn" lay-filter="logout" lay-submit><i class="layui-icon"></i>注销卡片</button>-->

<!--
            <a class="layui-btn layui-btn-danger layui-btn-xs"
               data-dropdown="#cardTbDrop{{d.LAY_INDEX}}">注销卡片</a>
            &lt;!&ndash;<a class="layui-btn layui-btn-xs" lay-event="reset">重置密码</a>&ndash;&gt;
            <div class="dropdown-menu-nav dropdown-popconfirm dropdown-top-right layui-hide"
                 id="cardTbDrop{{d.LAY_INDEX}}"
                 style="max-width: 200px;white-space: normal;min-width: auto;margin-left: 10px;">
                <div class="dropdown-anchor"></div>
                <div class="dropdown-popconfirm-title">
                    <i class="layui-icon layui-icon-help"></i>
                    &lt;!&ndash;确定要删除{{d.nickName}}吗？&ndash;&gt;
                    确定要注销卡片吗？
                </div>
                <div class="dropdown-popconfirm-btn">
                    <a class="layui-btn" btn-cancel>取消</a>
                    <a class="layui-btn layui-btn-normal" lay-event="logout">确定</a>
                </div>
            </div>
-->

        </div>


        <div class="layui-form-item text-right" style="margin-top: 15px;">
            <button class="layui-btn layui-btn-primary" ew-event="closeDialog">关闭</button>
        </div>
    </div>
</script>



<:include file="../common/js.html"/>
<script>
    layui.use(['layer', 'form', 'table', 'tableX', 'util', 'admin', 'xmSelect', 'formX', 'dropdown', 'upload', 'laydate'], function () {
        var $ = layui.jquery;
        var layer = layui.layer;
        var form = layui.form;
        var table = layui.table;
        var tableX = layui.tableX;
        var util = layui.util;
        var admin = layui.admin;
        var xmSelect = layui.xmSelect;
        var laydate = layui.laydate;
        var sites = [];  // 全部站点
        var customerList = JSON.parse('${customerList!}').map(function (d) {
            return {name: d.customerName, value: d.userId}
        });
        var type = '${type!}';

        function col(){
            //固定列二维数组
            var col = [[
                {field: 'purchase_request_id', title: '请求ID', minWidth: 120},
                {field: 'statusStr', title: '卡片状态', minWidth: 80},
                // {field: 'init_amount', title: '卡初始额度'},
                // {field: 'actual_amount', title: '实际卡额度'},
                // {field: 'external_amount', title: '对外卡额度'},
                {field: 'billingAmount', title: '已用额度'},
                // {field: 'external_remaining_amount', title: '剩于额度'},
                {field: 'card_number', title: '卡号', minWidth: 125},
                {field: 'end_time', title: '到期日', width: 90},
                // {field: 'pin', title: 'PIN码', width: 80},
                // {field: 'create_time', title: '开卡日', minWidth: 90},
                {field: 'external_create_time', title: '开卡日', minWidth: 90},
                // {field: 'customer_name', title: '分配用户', minWidth: 120},
                // {field: 'remark', title: '备注', minWidth: 160},
                {title: '卡片操作', toolbar: '#userTbBarCard', align: 'center', fixed: 'right', width: 165},
                // {title: '更新操作', toolbar: '#userTbBar', align: 'center', fixed: 'right', width: 115}
            ]];


            if(type == 0){
                // subjectTitle = ["实际卡额度", "对外卡额度"];
                subjectTitle = ["对外卡额度"];
                // subjectField = ["actual_amount", "external_amount"];
                subjectField = ["external_amount"];
                var oper = {title: '更新操作', toolbar: '#userTbBar', align: 'center', fixed: 'right', width: 115};
                col[0][col[0].length] = oper;


            }else{

                subjectTitle = ["卡额度"];
                subjectField = ["external_amount"];
            }

            subjectFields(col, 2, subjectField, subjectTitle);

            if(type == 0){
                console.log("有分配用户："+type)

                subjectTitle = ["分配用户", "备注"];
                subjectField = ["customer_name", "remark"];
                subjectFields(col, col[0].length-2, subjectField, subjectTitle);
            }


            return col;
        }



        /* 渲染表格 */
        var insTb = tableX.render({
            elem: '#cardDataTable',
            url: 'card/page',
            page: true,
            limits: [10,20,30,50,70,100,1000],
            // height: 'full-100',
            toolbar: ['<p>',
                '<button style="display:none" id="addBtn" lay-event="add" class="layui-btn layui-btn-sm icon-btn"><i class="layui-icon">&#xe654;</i>添加</button>&nbsp;',
                // '<button lay-event="add" class="layui-btn layui-btn-primary layui-btn-sm layui-btn-radius"><i class="layui-icon">&#xe654;</i>添加渠道成本</button>&nbsp;',
                // '<button lay-event="editOverall" class="layui-btn layui-btn-primary layui-btn-sm layui-btn-radius"><i class="layui-icon">&#xe642;</i>修改全局参数</button>&nbsp;',
                // '<button lay-event="del" class="layui-btn layui-btn-sm layui-btn-danger icon-btn"><i class="layui-icon">&#xe640;</i>删除</button>&nbsp;',
                // '<button lay-event="import" class="layui-btn layui-btn-sm layui-btn-warm icon-btn"><i class="layui-icon">&#xe681;</i>导入</button>',
                '<button lay-event="export" class="layui-btn layui-btn-sm layui-btn-warm icon-btn"><i class="layui-icon">&#xe681;</i>导出</button>',
                '</p>'].join(''),
            defaultToolbar: false,
            cellMinWidth: 100,
            // totalRow: true,
            done: function (res, curr, count) {

                // getSites();
                // lineChartInit(res.lineData.legendData, res.lineData.xAxisData, res.lineData.seriesData);

                // console.log("resres:"+JSON.stringify(res))
                if(res.type == 0){
                    // $('#addBtn').hide();
                    document.getElementById('addBtn').style.display='inline';
                }


            },
            cols: col()
        });


        /* 表格搜索 */
        form.on('submit(userTbSearch)', function (data) {

            console.log("data.field："+JSON.stringify(data.field))
            insTb.reload({where: data.field, page: {curr: 1}});
            return false;
        });


        // 清空
        form.on('submit(clearBtn)', function (data) {

            console.log("清空...")
            //执行清空
            $("#itemsId").empty();
            $("#jobNumber").empty();
            $("#adAccount").empty();
            // $("#adChannels").empty();
            $("#adChannels").val("");
            $("#searchTime").val(""); // 清空日期
            // form.render("select");

            // layui.form.render("select");//重新渲染 固定写法

            getSites(sitesData);


            form.render("select");//重新渲染 固定写法

        });


        /* 表格工具条点击事件 */
        table.on('tool(cardDataTable)', function (obj) {
            if ('edit' === obj.event) { // 修改
                showEditModel(obj.data);
            } else if ('del' === obj.event) { // 删除
                doDel(obj);
            } else if ('recharge' === obj.event) { // 充值
                // doDel(obj);
                showRechargeModel(obj.data);
            } else if ('allot' === obj.event) { // 分配卡片
                showAllotModel(obj.data);
            } else if ('logout' === obj.event) { // 注销卡片
                // admin.prompt(function (value, i) {
                //     layer.close(i);
                    var loadIndex = layer.load(2);
                    $.post('card/logout', {id: obj.data.id}, function (res) {
                        layer.close(loadIndex);
                        if (0 === res.code) {
                            layer.msg(res.msg, {icon: 1});
                            insTb.reload({page: {curr: 1}});
                        } else {
                            layer.msg(res.msg, {icon: 2, anim: 6});
                        }
                    });
                // });


            } else if ('reset' === obj.event) { // 重置密码
                admin.prompt({formType: 1, title: '请输入密码'}, function (value, i) {
                    layer.close(i);
                    var loadIndex = layer.load(2);
                    $.post('user/psw/reset', {id: obj.data.userId, password: value}, function (res) {
                        layer.close(loadIndex);
                        if (0 === res.code) {
                            layer.msg(res.msg, {icon: 1});
                        } else {
                            layer.msg(res.msg, {icon: 2, anim: 6});
                        }
                    });
                });
            } else if ('info' === obj.event) { // 详情

                console.log("info obj.data："+JSON.stringify(obj.data))
                console.log("info obj.data.id："+obj.data.id)

                var user_id = obj.data.user_id;
                // 没有分配用户而且不是管理员
                if(user_id && type != 0){
                    admin.prompt({formType: 1, title: '请输入二级密码'}, function (value, i) {
                        layer.close(i);
                        var loadIndex = layer.load(2);
                        $.post('user/psw/verifyTwoPassword', {id: user_id, twoPassword: value}, function (res) {
                            layer.close(loadIndex);
                            if (0 === res.code) {

                                admin.req('card/getCardInfo', {id: obj.data.id}, function (res) {
                                    console.log("info res："+JSON.stringify(res.data))

                                    admin.open({
                                        type: 1,
                                        title: '详情',
                                        area: '600px',
                                        content: admin.util.tpl($('#operRecordInfoDialog').html(), res.data)
                                    });

                                }, 'get');


                            } else {
                                layer.msg(res.msg, {icon: 2, anim: 6});
                            }
                        });
                    });
                }else{
                    admin.req('card/getCardInfo', {id: obj.data.id}, function (res) {
                        console.log("info res："+JSON.stringify(res.data))

                        admin.open({
                            type: 1,
                            title: '详情',
                            area: '600px',
                            content: admin.util.tpl($('#operRecordInfoDialog').html(), res.data)
                        });

                    }, 'get');

                }



            }

        });


        /* 表格头工具栏点击事件 */
        table.on('toolbar(cardDataTable)', function (obj) {
            if ('add' === obj.event) { // 添加
                // console.log("obj obj obj:"+JSON.stringify(obj))
                showEditModel();
                var itemId = $("#item_id").val();

            } /*else if ('del' === obj.event) { // 删除
                var checkRows = table.checkStatus('cardDataTable');
                if (!checkRows || !checkRows.data || 0 === checkRows.data.length) {
                    return layer.msg('请选择要删除的数据', {icon: 2, anim: 6});
                }
                var ids = checkRows.data.map(function (d) {
                    return d.userId;
                });
                doDel({ids: ids});
            }*/ else if ('editOverall' === obj.event) {
                showEditOverallModel();
            } else if ('import' === obj.event) {
                showImport();
            } else if ('export' === obj.event) {
                showExport();
            }
        });

        /* 表格头工具栏点击事件 */
        table.on('toolbar(operRecordInfoDialog)', function (obj) {
            if ('add' === obj.event) { // 添加
                // console.log("obj obj obj:"+JSON.stringify(obj))
                showEditModel();
                var itemId = $("#item_id").val();
                console.log("....1.11...itemId："+itemId)

            }
            else if ('editOverall' === obj.event) {
                showEditOverallModel();
            } else if ('import' === obj.event) {
                showImport();
            } else if ('allot' === obj.event) { // 分配卡片
                showAllotModel(obj.data);
            }

        });


        /* 表格搜索 */
        form.on('submit(allot)', function (data) {
            console.log("allot data.field:"+JSON.stringify(data.field))
            console.log("allot data.field:"+JSON.stringify(data))
            // console.log("allot3:"+admin.util.tpl($('#operRecordInfoDialog').html()))
            console.log("allot5:"+$('#operRecordInfoDialog').innerText)

            // console.log("allot4:"+admin.util.tpl($('#editFormDialogAllot').html()))

            showAllotModel(data);

            // return false;
        });

        /* 表格搜索 */
        form.on('submit(logout)', function (data) {

            // var operId = document.getElementById("requestId");

            layer.confirm('是否注销?', {icon: 2, title:'确认'}, function(index){
                //do something
                // alert("aa")


                layer.close(index);

                var id = data.field.id;
                var loadIndex = layer.load(2);
                $.post('card/logout', {id: id}, function (res) {
                    layer.close(loadIndex);
                    if (0 === res.code) {
                        layer.msg(res.msg, {icon: 1});
                        insTb.reload({page: {curr: 1}});
                        layer.closeAll();
                    } else {
                        layer.msg(res.msg, {icon: 2, anim: 6});
                    }
                });


            });
        });



        /* 充值 */
        form.on('submit(recharge)', function (data) {


            admin.prompt({formType: 1, title: '请输入充值金额'}, function (value, i) {
                layer.close(i);
                var loadIndex = layer.load(2);
                $.post('user/psw/reset', {id: obj.data.userId, password: value}, function (res) {
                    layer.close(loadIndex);
                    if (0 === res.code) {
                        layer.msg(res.msg, {icon: 1});
                    } else {
                        layer.msg(res.msg, {icon: 2, anim: 6});
                    }
                });
            });

        });




        function initCustomer2(){
            var vue = new Vue({
                el:'#customerApp2',
                data:{
                    customerList:customerList,
                    customer:'',

                },
                methods:{
                    getValue: function(){
                    }
                },

            });
        }
        function initCustomer(){
            var vue = new Vue({
                el:'#customerApp',
                data:{
                    customerList:customerList,
                    customer:'',

                },
                methods:{
                    getValue: function(){
                    }
                },

            });
        }


        var revenue = 0;
        /* 显示表单弹窗 */
        function showEditModel(mData) {
            admin.open({
                type: 1,
                area: '620px',
                offset: '20px',
                title: (mData ? '修改' : '添加') + '信息',
                content: $('#editFormDialog').html(),
                success: function (layero, dIndex) {
                    $(layero).children('.layui-layer-content').css('overflow', 'visible');

                    console.log("showEditModel customerList："+JSON.stringify(customerList))

                    initCustomer(); // 初始化客户名称

                    // 只有修改才显示
                    mData ? document.getElementById('externalCreateTimeDiv').style.display='block' : "";
                    mData ? document.getElementById('logoutTimeDiv').style.display='block' : "";



                    //年月选择器
                    laydate.render({
                        elem: '#createTime'
                        ,type: 'date'
                        // ,value: getDate(new Date().getTime()-(86400000)) // 2020-04-01 - 2020-04-04
                        ,value: getLastDate(new Date().getTime()) // 2020-04-01 - 2020-04-04
                        ,isInitValue: true
                        // ,showBottom :false
                        ,btns: ['confirm']
                        ,done: function(value, date){
                            console.log('....1你选择的日期是：' + value + '<br>获得的对象是' + JSON.stringify(date));
                            $('#createTime').val(value);
                            // getRevenue(value, channelId);
                        }
                    });


                    //年月选择器
                    laydate.render({
                        elem: '#externalCreateTime'
                        ,type: 'date'
                        // ,value: getDate(new Date().getTime()-(86400000)) // 2020-04-01 - 2020-04-04
                        ,value: getLastDate(new Date().getTime()) // 2020-04-01 - 2020-04-04
                        ,isInitValue: true
                        // ,showBottom :false
                        ,btns: ['confirm']
                        ,done: function(value, date){
                            console.log('....1你选择的日期是：' + value + '<br>获得的对象是' + JSON.stringify(date));
                            $('#externalCreateTime').val(value);
                            // getRevenue(value, channelId);
                        }
                    });

                    //年月选择器
                    laydate.render({
                        elem: '#logoutTime'
                        ,type: 'date'
                        // ,value: getDate(new Date().getTime()-(86400000)) // 2020-04-01 - 2020-04-04
                        ,value: getLastDate(new Date().getTime()) // 2020-04-01 - 2020-04-04
                        ,isInitValue: true
                        // ,showBottom :false
                        ,btns: ['confirm']
                        ,done: function(value, date){
                            console.log('....1你选择的日期是：' + value + '<br>获得的对象是' + JSON.stringify(date));
                            $('#logoutTime').val(value);
                            // getRevenue(value, channelId);
                        }
                    });



                    //年月选择器
/*
                    laydate.render({
                        elem: '#endTime'
                        ,type: 'month'
                        // ,value: getDate(new Date().getTime()-(86400000)) // 2020-04-01 - 2020-04-04
                        ,value: getLastDate(new Date().getTime()) // 2020-04-01 - 2020-04-04
                        ,isInitValue: true
                        // ,showBottom :false
                        ,btns: ['confirm']
                        ,done: function(value, date){
                            console.log('....1你选择的日期是：' + value + '<br>获得的对象是' + JSON.stringify(date));
                            $('#endTime').val(value);
                            // getRevenue(value, channelId);
                        }
                    });
*/


                    // 日期范围
                    laydate.render({
                        elem: '#endTime'
                        ,type: 'month'
                        // ,range: true
                        // ,eventElem: '#searchSubmitMenu'
                        // ,trigger: 'click'
                        ,value: getMonth(new Date().getTime()+(31536000000*1)) // 2020-04-01 - 2020-04-04
                        ,isInitValue: true
                        ,done: function(value, date){
                            console.log('你选择的日期是：' + value + '<br>获得的对象是' + JSON.stringify(date));
                            $('#endTime').val(value);

                        }
                    });

                    console.log("showEditModel mData："+JSON.stringify(mData))

                    // 回显表单数据
                    form.val('editForm', mData);

                    // 表单提交事件
                    form.on('submit(editSubmit)', function (data) {

                        console.log("JSON.stringify(data.field):"+JSON.stringify(data.field))
                        var loadIndex = layer.load(2);
                        admin.req(mData ? 'card/update' : 'card/add', data.field, function (res) {
                            layer.close(loadIndex);
                            if (0 === res.code) {
                                layer.close(dIndex);
                                // layer.msg(res.msg, {icon: 1});
                                admin.alert(res.msg.replace(/\r\n/g, '<br/>'), {icon: 1, anim: 6, title: '成功'});
                                insTb.reload({page: {curr: 1}});
                            } else {
                                // layer.msg(res.msg, {icon: 2, anim: 6});
                                admin.alert(res.msg.replace(/\r\n/g, '<br/>'), {icon: 2, anim: 6, title: '失败'});
                            }
                        }, 'post');

                        return false;
                    });


                    // 渲染多选下拉框
                    /*
                    var insRoleSel = xmSelect.render({
                        el: '#userEditRoleSel',
                        // name: 'userEditRoleSel',
                        layVerify: 'required',
                        layVerType: 'tips',
                        // data: roleList
                    });
                    */
                    // 回显选中角色
                    /*if (mData && mData.roles) {
                        insRoleSel.setValue(mData.roles.map(function (item) {
                            return item.roleId;
                        }));
                    }*/
                    // 禁止弹窗出现滚动条
                    // $(layero).children('.layui-layer-content').css('overflow', 'visible');
                }
            });
        }


        /* 显示分配用户弹窗 */
        function showAllotModel(mData) {
            admin.open({
                type: 1,
                // area: '620px',
                offset: '20px',
                title: (mData ? '分配' : '添加') + '信息',
                content: $('#editFormDialogAllot').html(),
                success: function (layero, dIndex) {
                    $(layero).children('.layui-layer-content').css('overflow', 'visible');

                    // console.log("showEditModel customerList："+JSON.stringify(customerList))
                    // console.log("showEditModel layero："+JSON.stringify(layero))
                    console.log("showEditModel dIndex："+dIndex)

                    // console.log("showEditModel mData："+JSON.stringify(mData))

                    console.log("showEditModel requestId："+$("#requestId").text())
                    console.log("showEditModel operId："+$("#operId").text())
                    console.log("showEditModel allotId："+$("#allotId").text())



                    // initItems(); // 初始化站点
                    // initChannel(); // 初始化渠道
                    initCustomer2(); // 初始化客户名称

                    /*
                                        var customerOptions = document.getElementById('customerId').children;
                                        if(customerOptions && customerOptions.length > 0){
                                            customerOptions[0].selected=true;
                                        }
                    */

                    console.log("showEditModel mData："+JSON.stringify(mData))
                    console.log("showEditModel id："+mData.field.id)

                    // 回显表单数据
                    form.val('editFormAllot', mData);

                    // 表单提交事件
                    form.on('submit(editSubmitAllot)', function (data) {

                        console.log("JSON.stringify(data.field):"+JSON.stringify(data.field))
                        var loadIndex = layer.load(2);
                        data.field.id=mData.field.id
                        admin.req('card/allot', data.field, function (res) {
                            layer.close(loadIndex);
                            if (0 === res.code) {
                                layer.close(dIndex);
                                layer.msg(res.msg, {icon: 1});
                                insTb.reload({page: {curr: 1}});
                                layer.closeAll();
                            } else {
                                layer.msg(res.msg, {icon: 2, anim: 6});
                            }
                        }, 'post');

                        return false;
                    });

                }
            });
        }


        /* 显示充值弹窗 */
        function showRechargeModel(mData) {
            admin.open({
                type: 1,
                // area: '620px',
                offset: '20px',
                title: (mData ? '充值' : '充值') + '信息',
                content: $('#editFormDialogRecharge').html(),
                success: function (layero, dIndex) {
                    $(layero).children('.layui-layer-content').css('overflow', 'visible');

                    console.log("showRechargeModel mData："+JSON.stringify(mData))
                    // console.log("showRechargeModel id："+mData.field.id)

                    // 回显表单数据
                    form.val('editFormRecharge', mData);

                    // 初始化充值页面值
                    admin.req('card/getCardInfo', {id: mData.id}, function (res) {
                        console.log("info res："+JSON.stringify(res.data))

                        document.getElementById("allot_recharge_amount").innerHTML = "<a style='color: red'>"+res.data.allot_recharge_amount+"</a>";

                        // document.getElementById("actual_amount").innerHTML = res.data.actual_amount;
                        var actual_amount = document.getElementById("actual_amount");
                        if(actual_amount){
                            actual_amount.innerHTML = res.data.actual_amount;
                        }
                        // document.getElementById("actual_remaining_amount").innerHTML = res.data.actual_remaining_amount;
                        var actual_remaining_amount = document.getElementById("actual_remaining_amount");
                        if(actual_remaining_amount){
                            actual_remaining_amount.innerHTML = res.data.actual_amount;
                        }

                        document.getElementById("external_amount").innerHTML = res.data.external_amount;
                        document.getElementById("external_remaining_amount").innerHTML = res.data.external_remaining_amount;

                        /*admin.open({
                            type: 1,
                            title: '详情',
                            area: '600px',
                            content: admin.util.tpl($('#operRecordInfoDialog').html(), res.data)
                        });*/


                    }, 'get');




                    // 表单提交事件
                    form.on('submit(editSubmitRecharge)', function (data) {

                        console.log("JSON.stringify(data.field)222:"+JSON.stringify(data.field))
                        var loadIndex = layer.load(2);
                        // data.field.id=mData.field.id
                        // data.field.customer_id = mData.customer_id;
                        console.log("JSON.stringify(data.field)333:"+JSON.stringify(data.field))
                        admin.req('card/recharge', data.field, function (res) {
                            layer.close(loadIndex);
                            JSON.stringify("recharge res:"+JSON.stringify(res))
                            if (0 === res.code) {
                                layer.close(dIndex);
                                layer.msg(res.msg, {icon: 1});
                                insTb.reload({page: {curr: 1}});
                            } else {
                                layer.msg(res.msg, {icon: 2, anim: 6});
                            }
                        }, 'post');

                        return false;
                    });

                }
            });
        }



        /* 删除 */
        function doDel(obj) {
            if (obj.ids) {
                admin.confirm('确定要删除选中数据吗？', function (i) {
                    layer.close(i);
                    var loadIndex = layer.load(2);
                    admin.req('card/update', JSON.stringify(obj.ids), function (res) {
                        layer.close(loadIndex);
                        if (0 === res.code) {
                            layer.msg(res.msg, {icon: 1});
                            insTb.reload({page: {curr: 1}});
                        } else {
                            layer.msg(res.msg, {icon: 2, anim: 6});
                        }
                    }, 'post');
                });
            } else {
                var loadIndex = layer.load(2);
                // $.get('cost/delete', {id: obj.data.userId}, function (res) {
                console.log("obj.data："+JSON.stringify(obj.data))
                $.get('card/delete', {id: obj.data.id}, function (res) {
                    layer.close(loadIndex);
                    if (0 === res.code) {
                        layer.msg(res.msg, {icon: 1});
                        insTb.reload({page: {curr: 1}});
                    } else {
                        layer.msg(res.msg, {icon: 2, anim: 6});
                    }
                });
            }
        }


        /* 修改用户状态 */
        /*
        form.on('switch(userTbStateCk)', function (obj) {
            var loadIndex = layer.load(2);
            $.post('user/state/update', {
                id: obj.elem.value,
                state: obj.elem.checked ? 0 : 1
            }, function (res) {
                layer.close(loadIndex);
                if (0 === res.code) {
                    layer.msg(res.msg, {icon: 1});
                } else {
                    layer.msg(res.msg, {icon: 2, anim: 6});
                    $(obj.elem).prop('checked', !obj.elem.checked);
                    form.render('checkbox', $('#cardDataTable').next().attr('lay-filter'));
                }
            });
        });
*/




        /* 导出到excel */
        function showExport() {

            console.log("showExport 导出到")


            var purchase_request_id = $("#purchase_request_id").val();
            var card_number = $("#card_number").val();
            var cardStatus = $("#cardStatus").val();
            var user_id = $("#user_id").val();

            var page = $(".layui-laypage-skip").find("input").val();
            var limit = $(".layui-laypage-limits").find("option:selected").val();

            console.log("purchase_request_id："+purchase_request_id)
            console.log("card_number："+card_number)
            console.log("cardStatus："+cardStatus)
            console.log("user_id：" + user_id)
            console.log("page：" + page)
            console.log("limit：" + limit)



            window.open("card/exportExcel?purchase_request_id="+purchase_request_id
                +"&card_number="+card_number+"&cardStatus="+cardStatus+"&user_id="+user_id+"&page="+page+"&limit="+limit);


        }



        /* 导入excel */
        function showImport() {
            admin.open({
                type: 1,
                title: '导入成本',
                content: ['<div style="padding: 20px 0 10px 0;text-align: center;" class="layui-text">',
                    '         <div id="userUploadDrag" class="layui-upload-drag" style="margin-bottom: 10px;">',
                    '            <i class="layui-icon">&#xe681;</i>',
                    '            <p>点击上传，或将文件拖拽到此处</p>',
                    '         </div>',
                    '         <div><a href="${ctxPath}/assets/file/广告渠道成本导入模板.xlsx" target="_blank" download>下载模板</a></div>',
                    '      </div>'].join(''),
                success: function (layero, dIndex) {
                    layui.upload.render({
                        elem: '#userUploadDrag',
                        url: 'channelCost/import',
                        accept: 'file',
                        exts: 'xls|xlsx',
                        before: function (obj) {
                            layer.load(2);
                        },
                        done: function (res) {
                            layer.closeAll('loading');
                            if (0 === res.code) {
                                // layer.msg(res.msg, {icon: 1});
                                layer.close(dIndex);
                                admin.alert(res.msg.replace(/\r\n/g, '<br/>'), {icon: 1, anim: 6, title: '导入完成'});
                                insTb.reload({page: {curr: 1}});
                            } else {
                                admin.alert(res.msg.replace(/\r\n/g, '<br/>'), {icon: 2, anim: 6, title: '导入失败'});
                            }
                        },
                        error: function () {
                            layer.msg('导入失败', {icon: 2, anim: 6});
                            layer.closeAll('loading');
                        }
                    });
                }
            });
        }



        // 日期范围
        laydate.render({
            elem: '#searchTime'
            ,type: 'date'
            ,range: true
            // ,eventElem: '#searchSubmitMenu'
            // ,trigger: 'click'
            ,value: getDate(new Date().getTime()-(86400000*30)) +" - "+ getDate(new Date().getTime()-(0)) // 2020-04-01 - 2020-04-04
            ,isInitValue: true
            ,done: function(value, date){
                console.log('你选择的日期是：' + value + '<br>获得的对象是' + JSON.stringify(date));
                $('#searchTime').val(value);

            }
        });

        function getDate(timeStamp){
            var date = new Date(timeStamp);

            var year = date.getFullYear(); //获取完整的年份(4位)

            var month = date.getMonth() + 1; //获取当前月份(0-11,0代表1月)
            month = month<10?"0"+month:month

            var date = date .getDate(); //获取当前日(1-31)
            date = date<10?"0"+date:date

            // var result = year + "-" + month + "-" + date;
            var result = year + "-" + month + "-" + date;

            return result;
        }

        function getMonth(timeStamp){
            var date = new Date(timeStamp);

            var year = date.getFullYear(); //获取完整的年份(4位)

            var month = date.getMonth() + 1; //获取当前月份(0-11,0代表1月)
            month = month<10?"0"+month:month

            var date = date .getDate(); //获取当前日(1-31)
            date = date<10?"0"+date:date

            // var result = year + "-" + month + "-" + date;
            var result = year + "-" + month;

            return result;
        }





    });


</script>
</body>
</html>
